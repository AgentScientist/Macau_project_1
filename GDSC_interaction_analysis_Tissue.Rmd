---
title: "A multi-task learning framework to uncover orthogonal feature interactions in large scale drug screening experiments"
author: "MI YANG"
date: "`r doc_date()`"
vignette: >
  %\VignetteIndexEntry{Bioconductor style for PDF documents}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output: 
  BiocStyle::html_document
---


```{r include=FALSE, cache=FALSE}
path <- "~/Documents/RWTH_Aachen"
source(paste0(path,"/MACAU_PROJECT/interaction_matrix_Functions.R"))
source(paste0(path,"/FUNCTIONS/PLOT.R"))
source(paste0(path,"/FUNCTIONS/general_functions.R"))
target <- read.csv(paste0(path,"/macau_work_dir/macau_test_sanger/DATA/target"), check.names = F) ; drug_names <- target[ ,1] ; target <- target[ ,-1]
DRUG_ANALYSIS_SET_update$Drug.Name <- DRUG_ANALYSIS_SET$DRUG_NAME

target_to_remove <- c()
for (i in 1:length(colnames(target))) {
protein_target <- print_target_GDSC (protein_target= colnames(target)[i], target_matrix=target, drug_names=drug_names )
if ( length(protein_target[,1]) == 1 ) { target_to_remove <- c(target_to_remove, i) }
}
target_to_remove <- c(target_to_remove , which(colnames(target) %in% c("others","not defined" ))  ) 

tissue_label_gdsc <- read.csv(paste0(path,"/SANGER_DATA/tissue_label_gdsc_ID"), row.names=1)
table(tissue_label_gdsc$tissue) ; names(which(table(tissue_label_gdsc$tissue) > 20)) 
tissue <- c("aero_dig_tract","bone","brain","breast","colon","kidney","leukemia","liver","lung_NSCLC","lung_SCLC","lymphoma","ovary","pancreas","skin","soft_tissue","stomach")
#  print_target_GDSC ( protein_target= "ERBB2" , target_matrix=target, drug_names=drug_names )
```


# Target - Progeny interaction (conservative/all_target , Single/Absolute)

```{r echo=FALSE, cache=FALSE}
save_interaction_plot("target","progeny11",selection="conservative",cut_off="single")

## PAN CANCER
x <- read.csv("~/Documents/RWTH_Aachen/macau_work_dir/macau_test_sanger/DATA_RESULT_STORAGE/transduction/interaction_target_progeny11_IC50_fold_sample600_latent30.csv", row.names = 1)
rownames(x)[grep("G9a and GLP methyltransferases",rownames(x))] <- "G9a and GLP"
rownames(x)[grep("dsDNA break induction",rownames(x))] <- "dsDNA break"
x <- x[ - target_to_remove ,  ] ; mat <- x
mat <- subset_row_abs(mat, abs_limit = 0.95, obs=1) ;  v <- apply(mat,1,var) ;  v <- v[ order(-abs(v)) ] ; mat <- mat[ names(v)[1:25] , ]
v <- apply(mat,2,var) ;  v <- v[ order(-abs(v)) ]  
pdf(paste("/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/PLOTS/interaction_PAN_CANCER_target_progeny11.pdf", sep = ""), width = 13 , height = 15, onefile = F )
plot_pheatmap(mat, row_names="Drug target", col_names="progeny11" , title="Pan cancer Target - Progeny11" ) 
dev.off()

## PAN CANCER
x <- read.csv("~/Documents/RWTH_Aachen/macau_work_dir/macau_test_sanger/DATA_RESULT_STORAGE/transduction/interaction_target_progeny14_IC50_fold_sample600_latent30.csv", row.names = 1)
rownames(x)[grep("G9a and GLP methyltransferases",rownames(x))] <- "G9a and GLP"
rownames(x)[grep("dsDNA break induction",rownames(x))] <- "dsDNA break"
x <- x[ - target_to_remove ,  ] ; mat <- x
mat <- subset_row_abs(mat, abs_limit = 0.95, obs=1) ;  v <- apply(mat,1,var) ;  v <- v[ order(-abs(v)) ] ; mat <- mat[ names(v)[1:25] , ]
v <- apply(mat,2,var) ;  v <- v[ order(-abs(v)) ]  
pdf(paste("/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/PLOTS/interaction_PAN_CANCER_target_progeny14.pdf", sep = ""), width = 13 , height = 15, onefile = F )
plot_pheatmap(mat, row_names="Drug target", col_names="progeny14" , title="Pan cancer Target - Progeny14" ) 
dev.off()


```


# Target - Progeny interaction (conservative/all_target , Single/Absolute)

```{r echo=FALSE, cache=FALSE}
save_interaction_plot("target","progeny14",selection="conservative",cut_off="single")

```


# Target - SLC ABC interaction (conservative/all_target , Single/Absolute)

```{r echo=FALSE, cache=FALSE}
save_interaction_plot_quantile(folder="SLC_TRANSPORTER","target","GEX_SLC_ABC",selection="conservative",cut_off="single")
save_interaction_plot(folder="SLC_TRANSPORTER","target","GEX_SLC_ABC",selection="conservative",cut_off="single")
save_interaction_plot_quantile(folder="SLC_TRANSPORTER","target","GEX_SLC_ABC",selection="all_target",cut_off="single")
save_interaction_plot(folder="SLC_TRANSPORTER","target","GEX_SLC_ABC",selection="all_target",cut_off="single")
save_interaction_plot_quantile(folder="SLC_TRANSPORTER","target","GEX_SLC_ABC",selection="all_target",cut_off="absolute")
save_interaction_plot(folder="SLC_TRANSPORTER","target","GEX_SLC_ABC",selection="all_target",cut_off="absolute")

## Retrieve Ranks and Weights across tissues
cell_rank <- retrieve_RANK_cell( folder="SLC_TRANSPORTER","CFTR",drug_feature_name="target",cell_feature_name="GEX_SLC_ABC")
drug_rank <- retrieve_RANK_drug( folder="SLC_TRANSPORTER","BIRC5",drug_feature_name="target",cell_feature_name="GEX_SLC_ABC")

interaction_rank <- retrieve_RANK_interaction(folder="SLC_TRANSPORTER",c("BIRC5","SLC35F2"),drug_feature_name="target",cell_feature_name="GEX_SLC_ABC")

## PAN CANCER
x <- read.csv("~/Documents/RWTH_Aachen/macau_work_dir/macau_test_sanger/DATA_RESULT_STORAGE/transduction/interaction_target_GEX_SLC_ABC_IC50_fold_sample600_latent30.csv", row.names = 1)
rownames(x)[grep("G9a and GLP methyltransferases",rownames(x))] <- "G9a and GLP"
rownames(x)[grep("dsDNA break induction",rownames(x))] <- "dsDNA break"
rownames(x)[grep("FNTA",rownames(x))] <- "FNTA"
mat <- x
# v <- apply(mat,2,sum) ; v <- v[ order(-abs(v)) ] ; mat <- mat[ , names(v)[1:30] ]
# v <- apply(mat,1,sum) ; v <- v[ order(-abs(v)) ] ; mat <- mat[ names(v)[1:30] , ]
v <- apply(mat,1,var) ;  v <- v[ order(-abs(v)) ] ; mat <- mat[ names(v)[1:30] , ]
v <- apply(mat,2,var) ;  v <- v[ order(-abs(v)) ] ; mat <- mat[ , names(v)[1:30] ]

mat <- quantile_normalisation(mat) ; mat["BIRC5","SLC35F2"]
plot_pheatmap(mat, row_names="Drug target", col_names="GEX" , title="Pan cancer Target - GEX" )

pdf(paste("/Users/miyang/Documents/RWTH_Aachen/SLC_TRANSPORTER/PLOTS/Target_SLC_ABC_interaction_PANCANCER.pdf", sep = ""), width = 30 , height = 20, onefile = F )
plot_pheatmap(mat, row_names="Drug target", col_names="GEX" , title="Pan cancer Target - GEX" )
dev.off()

```

# Tissue specific interaction of target-progeny

```{r echo=FALSE, cache=FALSE}

mat_list <- retrieve_interaction_plot("target","GEX_SLC_ABC",selection="conservative",cut_off="single") ;  
mat_tissue <- c()
for(i in 1:length(mat_list)) {
x <- mat_list[[i]]
y <- stack(x) ; ind2 <- rep( rownames(x) , 417) ; y <- cbind(y, ind2) ; rownames(y) <- paste0(y$ind,"_",y$ind2)  
mat_tissue <- cbind(mat_tissue, y$values)
}
rownames(mat_tissue) <- rownames(y) ; colnames(mat_tissue) <- tissue

mat <- mat_tissue
mat <- subset_row_abs(mat, abs_limit = 0.95, obs=1) ;  v <- apply(mat,1,var) ;  v <- v[ order(-abs(v)) ] ; mat <- mat[ names(v)[1:30] , ]
pdf(paste("/Users/miyang/Documents/RWTH_Aachen/SLC_TRANSPORTER/PLOTS/interaction_TISSUE_target_GEX_SLC_ABC_Divergence.pdf", sep = ""), width = 14.5 , height = 16, onefile = F )
plot_pheatmap(mat, row_names="SLC_ABC-Target pairs", col_names="Tissue" , title="Divergent interactions" ) 
dev.off()

mat <- mat_tissue
mat <- subset_row_abs(mat, abs_limit = 0.95, obs=1) ;  v <- apply(mat,1,var) ;  v <- v[ order(abs(v)) ] ; mat <- mat[ names(v)[1:30] , ]
pdf(paste("/Users/miyang/Documents/RWTH_Aachen/SLC_TRANSPORTER/PLOTS/interaction_TISSUE_target_GEX_SLC_ABC_Convergence.pdf", sep = ""), width = 14.5 , height = 16, onefile = F )
plot_pheatmap(mat, row_names="SLC_ABC-Target pairs", col_names="Tissue" , title="Convergent interactions" ) 
dev.off()

```


# Target - Progeny interaction: Tissue Gaps analysis

```{r echo=FALSE, cache=FALSE}
mat_list <- retrieve_interaction_plot("target","progeny11",selection="conservative",cut_off="single") ;  
x <- mat_list[[1]]

coord_value_table <- c()
across_tissue_value <- c()
for(t in 1:length(rownames(x))) {
  for(p in 1:length(colnames(x))) {
    across_tissue <- c()
    for(i in 1:length(mat_list)) {
      x <- mat_list[[i]]
      across_tissue <- c(across_tissue, x[t,p])
    }
    across_tissue_value <- rbind(across_tissue_value, across_tissue)
    coord_value_table <- rbind(coord_value_table,c(t,p, signif(max(across_tissue)-min(across_tissue), digits = 3) ))
  }
}

colnames(coord_value_table) <- c("target","pathway", "Max_Min_GAP")
colnames(across_tissue_value) <- tissue
rownames(across_tissue_value) <- 1:length(rownames(across_tissue_value))
boxplot( coord_value_table[,3] ) 
boxplot( t(across_tissue_value) ) 

subset <- coord_value_table[coord_value_table[ ,3] > 0.8 , ]
for(i in 1:length(subset[,1])) {  
  subset[i, 1] <- rownames(x)[as.numeric(subset[i, 1])]
  subset[i, 2] <- colnames(x)[as.numeric(subset[i, 2])]   
}

subset_across_tissue_value <- across_tissue_value[ coord_value_table[ ,3] > 0.8 , ]
max(subset_across_tissue_value[1,])-min(subset_across_tissue_value[1,])
maxmin_tissue <- c()
maxmin_value <- c()
for(i in 1:length(subset[,1])) {  
 maxmin_tissue <- rbind( maxmin_tissue , c(names(which.max(subset_across_tissue_value[i,])), names(which.min(subset_across_tissue_value[i,]))) )
 maxmin_value <- rbind( maxmin_value , c(signif(max(subset_across_tissue_value[i,]), digits = 3), signif(min(subset_across_tissue_value[i,]), digits = 3)) )
}
colnames(maxmin_tissue) <- c("Max_tissue", "Min_tissue")
colnames(maxmin_value) <- c("Max_value", "Min_value")

subset <- cbind(subset, maxmin_tissue, maxmin_value)
subset <- subset[ ,c( "pathway","target","Max_tissue", "Min_tissue","Max_value", "Min_value","Max_Min_GAP")]

absolute_sum <- abs(as.numeric(subset[ ,5]) + as.numeric(subset[ ,6]))
subset <- cbind(subset, absolute_sum)
subset <- subset[ subset[ ,8] < 0.2 , ]
```


# Tissue specific interaction of target-progeny: CONVERGENT/DIVERGENT interactions

```{r echo=FALSE, cache=FALSE}

mat_list <- retrieve_interaction_plot("target","progeny11",selection="conservative",cut_off="single") ;  
mat_tissue <- c()
for(i in 1:length(mat_list)) {
x <- mat_list[[i]]
y <- stack(x) ; ind2 <- rep( rownames(x) , 11) ; y <- cbind(y, ind2) ; rownames(y) <- paste0(y$ind,"_",y$ind2)  
mat_tissue <- cbind(mat_tissue, y$values)
}
rownames(mat_tissue) <- rownames(y) ; colnames(mat_tissue) <- tissue

mat_tissue <- scale(mat_tissue) ## scale by tissue !!!

mat <- mat_tissue
mat <- subset_row_abs(mat, abs_limit = 0.95, obs=1) ;  v <- apply(mat,1,var) ;  v <- v[ order(v) ] ; mat <- mat[ names(v)[1:30] , ]
pdf(paste("/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/PLOTS/interaction_TISSUE_target_progeny11_Convergence.pdf", sep = ""), width = 15 , height = 16, onefile = F )
plot_pheatmap(mat, row_names="Pathway-Target pairs", col_names="Tissue" , title="Convergent interactions" ) 
dev.off()

mat <- mat_tissue
mat <- subset_row_abs(mat, abs_limit = 0.95, obs=1) ;  v <- apply(mat,1,var) ;  v <- v[ order(-v) ] ; mat <- mat[ names(v)[1:30] , ]
pdf(paste("/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/PLOTS/interaction_TISSUE_target_progeny11_Divergence.pdf", sep = ""), width = 15 , height = 16, onefile = F )
plot_pheatmap(mat, row_names="Pathway-Target pairs", col_names="Tissue" , title="Divergent interactions" ) 
dev.off()


```


# Target - GEX interaction (conservative/all_target , Single/Absolute)

```{r echo=FALSE, cache=FALSE}
## not working, rerun macau on target-GEX
save_interaction_plot("target","GEX",selection="conservative",cut_off="single"  ,limit_col=0.999)

## PAN CANCER
path <- "/Users/miyang/Documents/RWTH_Aachen/macau_work_dir/macau_test_sanger/DATA_RESULT_STORAGE/transduction/"
x <- read.csv(paste(path,"interaction_target_GEX_IC50_fold_sample600_latent30.csv",sep=""),row.names=1)
GEX_ALL_names <- read.csv("~/Documents/RWTH_Aachen/macau_work_dir/macau_test_sanger/ORIGINAL_DATA/GEX_ALL_names", row.names=1); GEX_ALL_names$x <- as.character(GEX_ALL_names$x)
colnames(x) <- GEX_ALL_names$x
x <- x[ - target_to_remove ,  ]  
mat <- x
mat <- subset_col_abs(mat, abs_limit = 0.999, obs=1) 
v <- apply(mat,2,var) ;  v <- v[ order(-abs(v)) ] ; mat <- mat[ , names(v)[1:30] ]
v <- apply(mat,1,var) ;  v <- v[ order(-abs(v)) ] ; mat <- mat[ names(v)[1:20] , ]

pdf(paste("/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/PLOTS/interaction_PAN_CANCER_target_GEX.pdf", sep = ""), width = 20 , height = 13, onefile = F )
plot_pheatmap(mat, row_names="Drug target", col_names="GEX" , title="Pan cancer Target - GEX" )
dev.off()
```


# Target - Transcription factor activity interaction

```{r echo=FALSE, cache=FALSE}
save_interaction_plot("target","TF_score",selection="conservative",cut_off="single")

```

# Target - SNP CNV interaction

```{r echo=FALSE, cache=FALSE}
path <- "/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/DATA_RESULT_STORAGE/TISSUE_SPECIFIC_GDSC/target_SNP_CNV/" 
setwd(path) ; f <- list.files(path) ; data_folder <- list.files("/Users/miyang/Documents/RWTH_Aachen/SANGER_DATA/TISSUE" )

for(i in 1:length(f)) {
x <- read.csv(f[i], row.names=1) ; x <- x[ - target_to_remove ,  ] 
to_remove <- read.csv(paste("/Users/miyang/Documents/RWTH_Aachen/SANGER_DATA/TISSUE/",data_folder[i],"/SNP_CNV_to_Remove",sep=""), row.names=1)
x <- x[ ,-which(colnames(x) %in% to_remove$x)] ; mat <- x
s <- rowSums(mat) ; s <- s[ order(-abs(s)) ] ; mat <- mat[ names(s)[1:25] , ]
s <- rowSums(mat) ; s <- s[ order(-abs(s)) ] ; mat <- mat[ names(s)[1:20] , ]

tissue <- regmatches(f[i], regexpr('interaction.+?target', f[i])) ; tissue <- gsub('.{7}$', '', tissue) ; tissue <- substring(tissue, 13)
pdf(paste("/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/PLOTS/GDSC_Target_SNP_CNV/", tissue ,".pdf", sep = ""), width = 22 , height = 18, onefile = F )
plot_pheatmap(mat,"Drug target" , "SNP + CNV" , paste("Target - SNP_CNV (",tissue,")",sep = "")  ) 
dev.off()
}
```

# Target - GSVA Reactome interaction 

```{r echo=FALSE, cache=FALSE}
save_interaction_plot("target","GSVA_Reactome",selection="conservative",cut_off="single")

```

# Quality Control

```{r echo=FALSE, cache=FALSE}
SEED_chosen  <- "SEED_RANDOM"
list_of_name <- c("target_GEX","target_progeny11","target_SNP_CNV")

result_table <- c()
for(feature in 1:length(list_of_name)) {
path <- paste("/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/DATA_RESULT_STORAGE/TISSUE_SPECIFIC_GDSC/summary_QC/",SEED_chosen,"/",list_of_name[feature],"_QC/" ,sep = "" ) 
setwd(path) ; f <- list.files(path)  
mean <- c()
sd <- c()
for(i in 1:length(f)) {
  x <- list.files( paste(path, f[i],sep="") ) 
  x <- strsplit(x, "=") ; 
  mean <- c(mean, x[[1]][2] ) # take the mean pearson correlation
  sd <- c(sd, x[[length(x)]][2] ) # take the sd pearson correlation
}
result_table <- cbind( result_table, paste0(as.character(mean)," (sd=",as.character(sd),")" ) )  
}
rownames(result_table) <- f ; colnames(result_table) <- list_of_name
write.csv(result_table, paste("/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/DATA_RESULT_STORAGE/TISSUE_SPECIFIC_GDSC/summary_QC/",SEED_chosen,"_TABLE", sep = "")  )

# describe this table, according to sample size, some tissues need further investigations. 
```

# Significance test

```{r echo=FALSE, cache=FALSE}
SEED_chosen  <- "SEED_RANDOM"
# list_of_name <- c("target_GEX","target_progeny11","target_SNP_CNV")
# list_of_name <- c("target_GEX","target_progeny11")
# list_of_name <- c("target_progeny11","target_SNP_CNV")
# list_of_name <- c("target_GEX","target_SNP_CNV")

anova_result <- c()
for(t in 1:length(f)) {
  correlation_table <- c()
  for(feature in 1:length(list_of_name)) {
    path <- paste("/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/DATA_RESULT_STORAGE/TISSUE_SPECIFIC_GDSC/summary_QC/",SEED_chosen,"/",list_of_name[feature],"_QC/" ,sep = "" ) 
    setwd(path) ; f <- list.files(path)  
    x <- list.files( paste(path,f[t],sep="") , pattern="^pcorr") 
    correlation <- c()
    for(i in 1:length(x)) { 
      c <- read.csv(paste(path,f[t],"/",x[i],sep=""),row.names = 1) 
      correlation <- c(correlation, c$X0)
    }
    correlation_table <- cbind(correlation_table,correlation)
  }
  colnames(correlation_table) <- list_of_name
  
  ## ANOVA test  https://www.stat.wisc.edu/~yandell/st571/R/anova.pdf
  y <- c()
  for(i in 1:length(colnames(correlation_table))) {
    y = c(y,correlation_table[,i])
  }
  n = rep(length(correlation_table[,1]),length(colnames(correlation_table)))
  group = rep(1:length(colnames(correlation_table)), n)
  data = data.frame(y = y, group = factor(group))
  fit = lm(y ~ group, data)
  result <- anova(fit)
  anova_result <- c(anova_result , result$`Pr(>F)`[1])
}
anova_result <- cbind(f,anova_result) ; anova_result

```

# Drug - target profile

```{r echo=FALSE, cache=FALSE}
drug <- "BX-795"
nice_boxplot_list_indication(drug, indication = c(""))

x <- target[ which(DRUG_ANALYSIS_SET_update$Drug.Name == drug ) , ]
relevant_target <- colnames(x)[which(x[1,]==1)] 
if(length(which(relevant_target %in% c("others","not defined"))) > 0) {relevant_target <- relevant_target[-which(relevant_target %in% c("others","not defined"))]}

drug_mean <- IC50_tissue_mean[drug, ] ; drug_mean <- drug_mean[order(-drug_mean)] ; ordered_tissue <- names(drug_mean)

############################## create progeny matrix ##############################
path <- "/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/DATA_RESULT_STORAGE/TISSUE_SPECIFIC_GDSC/target_progeny11/" ; setwd(path) ; f <- list.files(path)
tissue <- regmatches(f, regexpr('interaction.+?target', f)) ; tissue <- gsub('.{7}$', '', tissue) ; tissue <- substring(tissue, 13)
liver <- which(tissue=="liver")
tissue <- tissue[-liver] ; f <- f[-liver]
tab <- cbind(f,tissue) ; tab <- tab[ order(match(tab[,2],ordered_tissue)) , ] ; f <- tab[,1]

mat_progeny <- c()
for(i in 1:length(f)) {
one_tissue <- read.csv(f[i], row.names=1)  ; one_tissue <- one_tissue[ relevant_target , ]
rownames(one_tissue) <- paste(rownames(one_tissue)," (",ordered_tissue[i],")", sep = "")
mat_progeny <- rbind(mat_progeny,one_tissue)
}
mat_progeny <- scale(mat_progeny)
plot_pheatmap(mat_progeny,"Drug target" , "Progeny Pathway activity" , paste(drug,sep = ""), cl = FALSE  ) 

############################## create TF score matrix ##############################
path <- "/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/DATA_RESULT_STORAGE/TISSUE_SPECIFIC_GDSC/target_TF_score/" ; setwd(path) ; f <- list.files(path)
tissue <- regmatches(f, regexpr('interaction.+?target', f)) ; tissue <- gsub('.{7}$', '', tissue) ; tissue <- substring(tissue, 13)
liver <- which(tissue=="liver")
tissue <- tissue[-liver] ; f <- f[-liver]
tab <- cbind(f,tissue) ; tab <- tab[ order(match(tab[,2],ordered_tissue)) , ] ; f <- tab[,1]

TF_name <- c()
for(i in 1:length(f)) {
one_tissue <- read.csv(f[i], row.names=1)  ; one_tissue <- one_tissue[ relevant_target , ]
rownames(one_tissue) <- paste(rownames(one_tissue)," (",ordered_tissue[i],")", sep = "")
s <- colSums(abs(one_tissue)) ; s <- s[ order(-abs(s))] ; name <- names(s)[1:2] 
TF_name <- c(TF_name, name)
}

TF_name <- unique(TF_name)

mat_TF <- c()
for(i in 1:length(f)) {
one_tissue <- read.csv(f[i], row.names=1)  ; one_tissue <- one_tissue[ relevant_target , ]
rownames(one_tissue) <- paste(rownames(one_tissue)," (",ordered_tissue[i],")", sep = "")
mat_TF <- rbind(mat_TF,one_tissue[ ,TF_name])
}
mat_TF <- scale(mat_TF)
plot_pheatmap(mat_TF,"Drug target" , "TF activity" , paste(drug,sep = ""), cl = FALSE  ) 

############################## create  SNP_CNV  matrix ##############################
path <- "/Users/miyang/Documents/RWTH_Aachen/MACAU_PROJECT/DATA_RESULT_STORAGE/TISSUE_SPECIFIC_GDSC/target_SNP_CNV/" ; setwd(path) ; f <- list.files(path)
tissue <- regmatches(f, regexpr('interaction.+?target', f)) ; tissue <- gsub('.{7}$', '', tissue) ; tissue <- substring(tissue, 13)
liver <- which(tissue=="liver")
tissue <- tissue[-liver] ; f <- f[-liver]
tab <- cbind(f,tissue) ; tab <- tab[ order(match(tab[,2],ordered_tissue)) , ] ; f <- tab[,1]

SNP_CNV_name <- c()
common_tissue_name <- list()
for(i in 1:length(f)) {
one_tissue <- read.csv(f[i], row.names=1)  ; one_tissue <- one_tissue[ relevant_target , ]
rownames(one_tissue) <- paste(rownames(one_tissue)," (",ordered_tissue[i],")", sep = "")
s <- colSums(abs(one_tissue)) ; s <- s[ order(-abs(s))] ; name <- names(s)[1:2] 
SNP_CNV_name <- c(SNP_CNV_name, name)
common_tissue_name[[i]] <- colnames(one_tissue)
}
common <- Reduce(intersect, common_tissue_name)
SNP_CNV_name <- unique(SNP_CNV_name) ; SNP_CNV_name <- SNP_CNV_name[which(SNP_CNV_name %in% common)]

mat_SNP_CNV <- c()
for(i in 1:length(f)) {
one_tissue <- read.csv(f[i], row.names=1)  ; one_tissue <- one_tissue[ relevant_target , ]
rownames(one_tissue) <- paste(rownames(one_tissue)," (",ordered_tissue[i],")", sep = "")
mat_SNP_CNV <- rbind(mat_SNP_CNV,one_tissue[ ,SNP_CNV_name])
}
mat_SNP_CNV <- scale(mat_SNP_CNV)
plot_pheatmap(mat_SNP_CNV,"Drug target" , "SNP CNV" , paste(drug,sep = ""), cl = FALSE  ) 

#################################### combine plot #####################################
mat <- cbind(mat_progeny, mat_TF)
plot_pheatmap(mat,"Drug target" , "Progeny - TF" , paste(drug,sep = ""), cl = FALSE  ) 

```


